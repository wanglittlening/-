# [ç³»ç»Ÿé¡¹]ä½¿ç”¨è¯´æ˜ï¼ˆäº†è§£æ–°åŠŸèƒ½ï¼‰
  1ã€åŸºæœ¬ä½¿ç”¨ï¼šctrl+alt+så‘¼å‡º  Esc éšè—
  2ã€å†…å®¹ç±»å‹è¯´æ˜ï¼šæœ‰é“¾æ¥å†…å®¹ï¼ˆç‚¹å‡»åè·³è½¬ï¼‰ï¼Œä¸ç®€è¿°å†…å®¹ï¼Œç‚¹å‡»åç›´æ¥å¯æŸ¥çœ‹çš„ç®€è¿°æ–‡æœ¬
  3ã€åˆ¶ä½œè®¢é˜…ï¼Œè¯·æŸ¥çœ‹å†…ç½®è®¢é˜…ï¼ŒæŒ‰ç€æ¥ã€‚
  4ã€â€œæœç´¢PROâ€æ¨¡å¼ï¼Œæœç´¢è¯­æ³•: "<æœç´¢å‡ºå¯æœç´¢ï¼Œå¦‚baidu><tabé”®><baiduæœç´¢çš„å†…å®¹ï¼Œå¦‚ ä»Šæ—¥çƒ­ç‚¹>"   
                   å–æ¶ˆæœç´¢PROæ¨¡å¼ï¼šshift+tab
  5ã€æ–°æ·»åŠ /ä¿®æ”¹çš„å†…å®¹ï¼Œéƒ½ä¼šæœ‰â€œNEWâ€çš„æ ‡ç­¾ï¼Œå¿«æœç´¢â€œNEWâ€è¯•è¯•å§~ ï¼ˆæŸ¥çœ‹æœ€è¿‘7å¤©ï¼‰
  6ã€å‘¼å‡ºæœç´¢æ¡†ç›´æ¥æŒ‰`tab`é”®ï¼Œè¾“å…¥é—®é¢˜å†å›è½¦å³å¯ä½“ç°AIç®€å•é—®ç­”åŠŸèƒ½ã€‚

[å®˜æ–¹Github Wiki](https://github.com/My-Search)  |  [æ›´æ–°æ—¥å¿—](https://github.com/My-Search/my-search/blob/master/%E6%9B%B4%E6%96%B0%E6%97%A5%E5%BF%97.md)


# [ç³»ç»Ÿé¡¹] å…³äºè„šæœ¬ï¼ˆä½œè€… & è„šæœ¬ï¼‰

**ä½œè€…ï¼š** Zhuang Jie
**è”ç³»ä¿¡æ¯ï¼š** 2119299531@qq.com
**è„šæœ¬ç®€è¿°ï¼š**
æˆ‘ä¸€ç›´çƒ­çˆ±æ”¶é›†å„ç±»è½¯ä»¶å’Œç½‘ç«™ï¼Œå› æ­¤ç§¯ç´¯äº†å¤§é‡çš„ä¿¡æ¯ã€‚ä¹‹å‰ï¼Œæˆ‘å¸¸å¸¸é€šè¿‡æ–‡å­—æœç´¢ï¼ˆä½¿ç”¨ Ctrl+F æ–¹å¼ï¼‰åœ¨è®°å½•ä¸­æ‰¾åˆ°æ‰€éœ€ä¿¡æ¯ã€‚ç„¶è€Œï¼Œè¿™ç§æ–¹å¼å¹¶ä¸æ€»æ˜¯é«˜æ•ˆè€Œç›´è§‚ã€‚å› æ­¤ï¼Œæˆ‘å¼€å‘äº†è¿™æ¬¾è„šæœ¬ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘æ›´å¿«åœ°æ£€ç´¢å’Œå¯¼èˆªåˆ°æˆ‘éœ€è¦çš„ä¿¡æ¯ã€‚é€šè¿‡è¿™æ¬¾è„šæœ¬ï¼Œæˆ‘èƒ½å¤Ÿæ›´æœ‰æ•ˆåœ°ç®¡ç†å¹¶ä½¿ç”¨æˆ‘çš„æ”¶é›†çš„æ‰€æœ‰èµ„æºã€‚
[æ›´æ–°æ—¥å¿—](https://github.com/My-Search/my-search/blob/master/%E6%9B%B4%E6%96%B0%E6%97%A5%E5%BF%97.md) | [æ„è§åé¦ˆ/å†…å®¹æäº¤](https://github.com/18476305640/xiaozhuang/issues/new)  | [å®˜æ–¹å¾®ä¿¡å…¬ä¼—-è®¢é˜…å·ï¼ˆâ€œæˆ‘çš„æœç´¢-æœæˆ‘æƒ³æœâ€ï¼‰](https://cdn.jsdelivr.net/gh/18476305640/typora@master/images/2024/10/01/1727798358767.jpg)

**åŸºæœ¬ç´ å…»ï¼š**
1. [å›½é™…ç½‘ç»œæ•™ç¨‹](https://www.kdocs.cn/l/cpDAFTH9GCaE) | æˆ‘çš„æœç´¢ç¦åˆ©æœºåœºï¼š[>>ä¸€é”®å¯¼å…¥<<](clash://install-config?url=https%3A%2F%2Fsub2.smallstrawberry.com%2Fapi%2Fv1%2Fclient%2Fsubscribe%3Ftoken%3D2bfb524a3b4e4c9b861e3054746a9d21)


**è„šæœ¬æŠ€æœ¯æ”¯æŒï¼š**
- [å®ç°MDè½¬HTML](https://github.com/18476305640/xiaozhuang/blob/dev/script-supper/%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0md%E8%BD%AChtml.md)
- åé¢å¼€å‘äºŒç»´ç å®ç°æŠ€æœ¯æ”¯æŒ-[qrcodejs](https://github.com/davidshimjs/qrcodejs)

**ä½œè€…ä½œå“ï¼š**
- [è®°ä½é˜…è¯»è¿›åº¦-è„šæœ¬ï¼ˆæ²¹çŒ´è„šæœ¬ï¼Œè®°ä½é¡µé¢çš„æ»šåŠ¨è¿›åº¦ï¼‰](https://greasyfork.org/zh-CN/scripts/452142-%E8%AE%B0%E4%BD%8F%E9%98%85%E8%AF%BB%E8%BF%9B%E5%BA%A6)
- [TabAutoCloseè°·æ­Œæµè§ˆå™¨æ’ä»¶-æ ¹æ®è§„åˆ™è‡ªåŠ¨å…³é—­æ ‡ç­¾](https://github.com/18476305640/TableClose)
- **è„šæœ¬ç”¨æˆ·ä¸“äº«** Booseæ‰¾å·¥ä½œè„šæœ¬[Auto Batch Push](https://github.com/My-Search/Auto_Boss_Batch_Push)

**æ”¯æŒä½œè€…**
å¦‚æœä½ è§‰å¾—æˆ‘ä»¬çš„äº§å“æœ‰ä»·å€¼ï¼Œå¹¶å¸Œæœ›æˆ‘ä»¬èƒ½æŒç»­æ”¹è¿›å’Œå¼€å‘æ–°çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬çœŸè¯šçš„è¯·æ±‚ä½ è€ƒè™‘æ”¯æŒæˆ‘ä»¬ã€‚ä½ å¯ä»¥é€‰æ‹©ææ¬¾ã€‚æ¯ä¸€æ¬¡çš„æ”¯æŒï¼Œå¯¹æˆ‘ä»¬éƒ½éå¸¸é‡è¦ã€‚

![å¾®ä¿¡/æ”¯ä»˜å®](https://cdn.jsdelivr.net/gh/18476305640/typora@master/images/2023/07/24/1690179329689.png)



# [h'è„šæœ¬'][ç³»ç»Ÿé¡¹]æ–°æ•°æ®é¡¹ï¼ˆè®¢é˜…ä½œè€…æ–°æ·»åŠ çš„é¡¹ï¼‰
-- env --
_icon data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCAwIDY0IDY0IiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiPgoJPHRpdGxlPuaWsOW7uumhueebrjwvdGl0bGU+Cgk8c3R5bGU+CgkJLnMwIHsgZmlsbDogI2ZmMDAwMCB9IAoJCS5zMSB7IG9wYWNpdHk6IC42O2ZpbGw6ICNmZjAwMDAgfSAKCQkuczIgeyBvcGFjaXR5OiAuNDtmaWxsOiAjZmYwMDAwIH0gCgk8L3N0eWxlPgoJPHBhdGggaWQ9IuW9oueKtiAxIiBjbGFzcz0iczAiIGQ9Im00LjggMTQuMWg1NC4ydjYuOGgtNTQuMnoiLz4KCTxwYXRoIGlkPSLlvaLnirYgMyIgY2xhc3M9InMxIiBkPSJtNSAyOC4xaDU0djYuOGgtNTR6Ii8+Cgk8cGF0aCBpZD0i5b2i54q2IDQiIGNsYXNzPSJzMiIgZD0ibTUgNDIuMWg1NHY2LjhoLTU0eiIvPgoJPHBhdGggaWQ9IuW9oueKtiAyIiBjbGFzcz0iczAiIGQ9Im0zMiAzMnoiLz4KPC9zdmc+
-- script -- 
function ( {registry} ) {
  registry.searchData.triggerSearchHandle(registry.searchData.specialKeyword.new); 
}
# [h'è„šæœ¬']å†å²è®°å½•ï¼ˆæœ€è¿‘æŸ¥çœ‹çš„é¡¹ï¼‰
-- env --

-- script -- 
function ( {registry} ) {
  registry.searchData.triggerSearchHandle(registry.searchData.specialKeyword.history); 
}
# [h'è„šæœ¬'] æˆ‘çš„HOTï¼ˆè„šæœ¬ä½¿ç”¨è€…ç»å¸¸é€‰æ‹©çš„é¡¹ï¼‰
-- env --

-- script -- 
function ( {registry} ) {
  registry.searchData.triggerSearchHandle(registry.searchData.specialKeyword.highFrequency); 
}

# [h'è„šæœ¬'][h'é—®AI'][h'ç³»ç»Ÿé¡¹'] AIï¼ˆä½¿ç”¨ChatGPTä½œä¸ºæœåŠ¡ç«¯ï¼Œé›†æˆåˆ°æœ¬è„šæœ¬ï¼Œå®ç°å¿«æ·çš„AIé—®ç­”åŠŸèƒ½ï¼‰
-- env --
_icon data:image/png;base64,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

_describe ä½¿ç”¨çš„å…¬ç›ŠchatGPTApiæ¥æ”¯æŒçš„å†…ç½®AIåŠ©æ‰‹
-- script --
function main({ cache, $, view }) {
  view.mount();
}


-- view:css --
span,
p,
div {
  color: #000000;
}
#msg {
  color: #FCBD18;
}
#chat-control {
  display: flex;
  align-items: stretch;
  height: 30px;
}
#chat-control select,
#chat-control input,
#chat-control button {
  padding: 5px 10px;
  margin-right: 2px;
  font-size: 14px;
}

#conversation-history {
   margin-bottom: 1rem;
   border: 1px solid #ccc;
   padding: 0.5rem;
   min-height: 50px;
}
pre {
  display: flex;
  flex-direction: column;
  margin: 3px 0;
}
pre .code-type {
    display: block;
    margin: 2px 5px;
    color: #bcbcbc;
    /*ä»£ç ç±»å‹ä¸å¯é€‰ä¸­*/
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  
}

.ä½ -message {
   color: #007BFF;
}

.AI-message {
   color: #28A745;
}


.ç³»ç»Ÿ-message {
   color: red;
}

#loading {
   display: inline-block;
   width: 20px;
   height: 20px;
   border: 4px solid rgba(0, 0, 0, 0.1);
   border-top-color: #000;
   border-radius: 50%;
   animation: spin 1s linear infinite;
}
#prompt {
  margin: 10px 0;
  display: flex;
  justify-content: space-around;
}
#prompt #prompt-list {
  display: flex;
  flex-wrap: wrap;
  flex-grow: 1;
}
#prompt-list > .optional {
    background: #ededed;
    border-radius: 8px;
    color: #7a7a7a;
    padding: 0 6px;
    cursor: pointer;
    white-space: nowrap;
    margin:0 2px 4px;
    height: 28px;
    line-height: 28px;
}
#prompt-list > .selected {
  border: 1px solid red;
    box-sizing: border-box;
    background: #fffd0042;
}
#prompt input {
    border-radius: 8px;
    font-size: 10px;
    padding: 0px 10px;
    border: 1px solid #6e6e6e;
}
@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

-- view:html --
<p id="msg"></p>
<div id="conversation-history"></div>
<div id="prompt">
  <span>çŸ¥è¯†åº“/æç¤ºè¯ï¼š</span>
  <div id="prompt-list">
    <span key="[WS]" class="optional">ğŸ“•è”ç½‘çŸ¥è¯†åº“</span>
    <span key="[RP]" class="optional">ğŸ“„è¯»å½“å‰é¡µé¢</span>
    <span key="[SD]" class="optional">ğŸ—‚ï¸åŸºäºæœç´¢é¡¹</span>
  </div>
  <input id="role_add_input" placeholder="ğŸ“å®šä¹‰AIè§’è‰²..å›è½¦æ·»" />
</div>
<div id="chat-control">
  <select id="model-select">
  </select>
  <input type="text" id="chat-input">
  <button id="chat-btn">send</button>
</div>

-- view:js --
console.log("è¿›å…¥viewScript")
let msgElement = document.querySelector("#msg");
if(window.MS_SCRIPT_ENV == null) {
  msgElement.innerText = "å½“å‰è„šæœ¬æ— æ‰€éœ€APIæ”¯æŒï¼Œä¸ºç¡®ä¿æ­£å¸¸ä½¿ç”¨ï¼Œè¯·æ›´æ–°è„šæœ¬åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚"
  window.MS_SCRIPT_ENV = {
    cache: {
      set(key,value) {},
      get(key) {return null;}
    },
    getSearchDB() {return []},
    event: window.MS_script_env_var.event
  }
}


let config = (()=>{
  return window.MS_SCRIPT_ENV.cache.get("ms_ai_config")
})();
function reCacheConfig() {
  window.MS_SCRIPT_ENV.cache.set("ms_ai_config",config)
}
if(config == null) {
  config = {
    roles: []
  }
  reCacheConfig()
}
const roleList = document.querySelector('#prompt #prompt-list')

function pushRoleToList({name,describe} = {}) {
  const newSpan = document.createElement('span');
  newSpan.classList.add('optional');
  
  newSpan.textContent = name;
  newSpan.setAttribute('key', describe);

  roleList.appendChild(newSpan);
}
// æ¸²æŸ“ç¼“å­˜çš„è§’è‰²
config.roles.forEach(role => pushRoleToList(role))

document.querySelector('#prompt #role_add_input').addEventListener('keydown', function(event) {
  // åˆ¤æ–­æ˜¯å¦æ˜¯å›è½¦é”®
  if (event.key === 'Enter') {
    const inputValue = this.value.trim(); // è·å–è¾“å…¥æ¡†çš„å€¼ï¼Œå¹¶å»é™¤ä¸¤ç«¯ç©ºæ ¼

    if (inputValue) {
      // åˆ›å»ºæ–°çš„ span å…ƒç´ 
      const ivArr = inputValue.split(/::/)
      const newRoleItem = {
        name: ivArr[0],
        describe: ivArr.length > 1 ? ivArr[1] : ivArr[0]
      };
      config.roles.push(newRoleItem)
      reCacheConfig();
      pushRoleToList(newRoleItem);
      // æ¸…ç©ºè¾“å…¥æ¡†
      this.value = '';
    }
  }
});
// è§’è‰²/çŸ¥è¯†åº“ç‚¹å‡»
// ç»‘å®šäº‹ä»¶ç›‘å¬å™¨åˆ° #prompt-list çˆ¶å…ƒç´ 


// äº‹ä»¶å§”æ‰˜ï¼šç›‘å¬çˆ¶å…ƒç´ çš„åŒå‡»äº‹ä»¶
roleList.addEventListener('dblclick', function(event) {
  // åˆ¤æ–­æ˜¯å¦æ˜¯ç‚¹å‡»çš„ span å…ƒç´ 
  console.log("tagName=",event.target.tagName)
  if (event.target && event.target.tagName === 'SPAN') {
    // è·å–æ–‡æœ¬å†…å®¹
    const text = event.target.textContent || event.target.innerText;

    // åˆ é™¤å…ƒç´ å‰è¾“å‡ºæ–‡æœ¬
    console.log('è¦åˆ é™¤çš„æ–‡æœ¬:', text);
    // ä»è§„åˆ™ä¸­åˆ é™¤
    config.roles = config.roles.filter(role => role.name !== text)
    reCacheConfig();
    // åˆ é™¤ç‚¹å‡»çš„å…ƒç´ 
    event.target.remove();
  }
});
roleList.addEventListener('click', function(event) {
  // ç¡®ä¿ç‚¹å‡»çš„å…ƒç´ æ˜¯ span
  if (event.target.tagName.toLowerCase() === 'span') {
    // å¦‚æœå½“å‰ç‚¹å‡»çš„ span å·²ç»æœ‰ selected ç±»ï¼Œåˆ™ç§»é™¤å®ƒ
    if (event.target.classList.contains('selected')) {
      event.target.classList.remove('selected');
    } else {
      // å¦åˆ™å…ˆç§»é™¤å…¶ä»– span çš„ selected ç±»ï¼Œå†ä¸ºå½“å‰ç‚¹å‡»çš„ span æ·»åŠ  selected ç±»
      document.querySelectorAll('#prompt-list > span').forEach(function(otherSpan) {
        otherSpan.classList.remove('selected');
      });
      event.target.classList.add('selected');
    }
  }
});


// è·å– key çš„ value
function getSelectedItem() {
  const selectedSpan = document.querySelector('#prompt-list > span.selected');
  if(selectedSpan == null) return null
  return {
    name: selectedSpan.innerText,
    describe: selectedSpan.getAttribute('key')
  }
}

const headers = new Headers();
headers.append("Content-Type", "application/json");
function getAnyOne(keys = []) {
  const randomIndex = Math.floor(Math.random() * keys.length);
  return keys[randomIndex];
}
function trimString(str, trimStr) {
  // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å»é™¤å‰åæŒ‡å®šçš„å­—ç¬¦ä¸²
  const regex = new RegExp(`^${trimStr}|${trimStr}$`, 'g');
  return str.replace(regex, '');
}
// ç¼–ç ï¼šwindow.btoa("raw")
// è§£ç ï¼šwindow.atob("processed")
const providerList = [
  'ewogICAgImJhc2VVcmwiOiBbImh0dHBzOi8vZnJlZS52MzYuY20vdjEiXSwKICAgICJrZXlzIjogWwogICAgICAic2stNElJcFRPdDgwTmR0STZHOTEyRGExZkY4N2YzYTRhMGJCYjA2MmVBNDQ3N2NDMjUyIiwKICAgICAgInNrLWxSdFo5dTdyYTcwcjJZQjhCODBlOWNEMDE4MDA0MUI1QWM0MjcwQzBBMzgwMWUwMCIsCiAgICAgICJzay12cnI1WWVQMWlmYkp2S3VVMzNDOERkQjMwM0I5NDczM0E3Q2RDYzE0RTJEY0U4QWYiCiAgICBdLAogICAgIm1vZGVsIjogWyJncHQtNG8tbWluaSIsImdwdC0zLjUtdHVyYm8tMDEyNSIsImdwdC0zLjUtdHVyYm8tMTEwNiIsInNlbGVjdGVkOmdwdC0zLjUtdHVyYm8iLCJncHQtMy41LXR1cmJvLTE2ayIsIm5ldC1ncHQtMy41LXR1cmJvIiwid2hpc3Blci0xIiwiZGFsbC1lLTIiXQogIH0=',

  'ewogICAgImJhc2VVcmwiOiBbImh0dHBzOi8vYXBpLmNoYXRhbnl3aGVyZS50ZWNoL3YxIiwiaHR0cHM6Ly9hcGkuY2hhdGFueXdoZXJlLm9yZy92MSJdLAogICAgImtleXMiOiBbCiAgICAgICJzay1hYVU4dkM3Sk93dXpQRUpVaXJENXVqb3cyWndTTUNIc3lGT2pTbUM1Z2EwY0hWNTQiLAogICAgICAic2stM2p6Y0FhUGg2NGVvUENzQWREMmI3V0RESVZPcW0yQ2FUc0dLQVdFTFVaYXJNSXRpIiwKICAgICAgInNrLUpjdDltUVJXMEpqdzZ2OG9qSU9Qb3J1MklkbEd3ZlVoRmFwZW4xSnQxemZUazN5SyIKICAgIF0sCiAgICAibW9kZWwiOiBbImdwdC00Iiwic2VsZWN0ZWQ6Z3B0LTMuNS10dXJibyIsImdwdC00LWNhIiwiZ3B0LTMuNS10dXJiby1jYSJdCiAgfQ=='
]
// é€‰æ‹©ä¸€ä¸ªæœåŠ¡æä¾›è€…ä¿¡æ¯
let sessionProvider = {
  ...(typeof providerList[0] === "string" ? JSON.parse(atob(getAnyOne(providerList))) : getAnyOne(providerList)),
  chooseOut: function() {
    return {
      baseUrl: getAnyOne(sessionProvider.baseUrl),
      key: getAnyOne(sessionProvider.keys),
      defaultChooseModel: trimString(this.model.find(m => m.startsWith("selected:")) || this.model[0],"selected:")
    }
  }
}
let sessionProviderSpecific = sessionProvider.chooseOut();

// å†å²å¯¹è¯è®°å½•
let isLoading = false;
const inputDocument = document.getElementById("chat-input");
const sendBtn = document.querySelector("#chat-btn");
const selectElement = document.getElementById("model-select");
headers.append("Authorization", `Bearer ${sessionProviderSpecific.key}`);
// å°†æ¨¡å‹æ”¾åˆ°ä¸‹æ‹‰æ¡†ä¸­
sessionProvider.model.forEach(currentModel => {
  const option = document.createElement("option");
  
  option.selected = (currentModel = trimString(currentModel,"selected:")) === sessionProviderSpecific.defaultChooseModel;
  option.value = option.textContent = currentModel;
  
  selectElement.appendChild(option);
});

function chatClickAction() {
  openLoading();
  inputDocument.value = ''
  // disable æŒ‰é’®
  sendBtn.disabled = true;
}
const getInitConversationHistory = (()=>{
  let conversationHistory = [];
  let lastPrompt = "";
  return async function(userInput) {
    const selectedItem = getSelectedItem();
    let prompt = selectedItem?.describe;
    let isAlreadySwitched = prompt !== lastPrompt;
    if(isAlreadySwitched) {
      const isHasLastHistory = conversationHistory.length > 0; 
      conversationHistory = [] // promptæ”¹å˜ï¼ŒConversationHistoryé‡ç½®
      lastPrompt = prompt
      if(isHasLastHistory) appendToConversationHistory("ç³»ç»Ÿ", "----åˆ‡æ¢è§’è‰²/çŸ¥è¯†åº“å†å²å·²è¢«æ¸…ç†----", Date.now());
    }else {
      conversationHistory;
    }
    // å¦‚æœæ˜¯æœ‰å«æ„çš„ï¼Œéœ€è¦è§£æçœŸæ­£prompt
    let isForcePrompt = false;
    if("[WS]" === prompt) {
      // è”ç½‘çŸ¥è¯†åº“
      const response = await fetch(`https://api.pearktrue.cn/api/aisearch/?keyword=${userInput}`, {method: 'GET'});
      if (response.ok) {
        const data = await response.json();  // è§£æ JSON æ ¼å¼çš„å“åº”ä½“
        prompt = `
        ---------------
        ä¸‹é¢æ˜¯é€šè¿‡ç½‘ç»œæœç´¢çš„æ•°æ®, è¯·ä½ ç»“åˆä¸‹é¢æœç´¢æ•°æ®å›å¤ç”¨æˆ·é—®é¢˜ã€‚
        ---------------
        ${JSON.stringify(data.data.text)}
        ---------------
        ` 
      } else {
        console.error('Error fetching data:', response.status);
        alert("è·å–ç½‘ç»œæ•°æ®å¤±è´¥~ï¼Œå¯ä»¥æ¢ä¸ªé¡µé¢è¯•è¯•")
      }
      // å¦‚æœå†å²ä¸ä¸ºç©ºï¼Œè¿™é‡Œéœ€è¦æ‰‹åŠ¨æ·»åŠ ï¼Œè®¾ç½®ä¸ºå¼ºPromptåé¢æ·»åŠ 
      isForcePrompt = true;
    }else if("[RP]" === prompt && isAlreadySwitched){
      let bodyHtml = document.body.outerHTML;
      // æˆ‘çš„æœç´¢çš„html
      let msHtml = document.querySelector("#my_search_box").innerHTML;
      prompt = `
      ---------------
      ä¸‹é¢æ˜¯å½“å‰é¡µé¢htmlæ•°æ®ï¼Œè¯·ä½ ç»“åˆä¸‹é¢é¡µé¢æ•°æ®å›å¤ç”¨æˆ·é—®é¢˜ã€‚
      ---------------
      ${bodyHtml.replace(msHtml,'')}
      ---------------
      `;
    }else if("[SD]" === prompt && isAlreadySwitched) {
      if(window.MS_SCRIPT_ENV == null) {
        alert("è¯·æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬è„šæœ¬ï¼Œæ­¤ç‰ˆæœ¬æœªæä¾›APIæ”¯æŒï¼")
      }else {
        const searchData = (window.MS_SCRIPT_ENV.getSearchDB() ?? []).map(e => `${(e.title ?? '').replace(/\[.*\]/gm,'').trim()}æ˜¯${e.desc.includes('-æ— æè¿°-')?'':e.desc}`);
        prompt = `
          ---------------
          ä¸‹é¢æ˜¯åº”ç”¨æœç´¢çš„æ•°æ®ï¼Œè¯·ä½ ç»“åˆä¸‹é¢æ•°æ®å›å¤ç”¨æˆ·é—®é¢˜æˆ–å›å¤ç”¨æˆ·æé—®æœ€ç¬¦åˆçš„é¡¹ã€‚
          ---------------
          ${JSON.stringify(searchData)}
          ---------------
          `;
      }
    }
    debugger

    if(conversationHistory.length === 0 || isForcePrompt) {
      if(prompt != null) {
        // å½“æ²¡æœ‰æç¤ºè¯æ—¶ï¼Œå½“æ²¡æœ‰å†å²æ‰åŠ åŸºæœ¬çš„è§’è‰²æç¤ºè¯
        conversationHistory.push({ 
          role: "system", 
          content: /^\[.*\]$/.test(selectedItem.describe) ? prompt: `ä½ å½“ä»»${selectedItem.name},ä½ çš„ä»»åŠ¡æ˜¯${selectedItem.describe}ã€‚` 
        })
      }else {
         conversationHistory.push({ role: "system", content: 'ä½ æ˜¯ä¹äºåŠ©äººAIåŠ©ç†' })
      }
    }
    console.log('conversationHistory=',conversationHistory)
    return conversationHistory;
  }
})();

async function chat() {
  if(sendBtn.disabled) return;

  const userInput = inputDocument.value;
  const messageId = "user-" + Date.now();

  appendToConversationHistory("ä½ ", userInput, messageId);
  chatClickAction();

  let conversationHistory = await getInitConversationHistory(userInput);
  conversationHistory.push({ role: "user", content: userInput });

  const requestOptions = {
    method: 'POST', headers,
    body: JSON.stringify({
      model: selectElement.value, // ä¸‹æ‹‰æ¡†aiæ¡†æ¶é€‰æ‹©å€¼
      messages: conversationHistory,
      stream: true
    }),
  };

  fetch(`${sessionProviderSpecific.baseUrl}/chat/completions`, requestOptions)
    .then(async response => {
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let partialMessage = ""; // Partial message from the stream
      let aiMessage = ''
      // æ¶ˆæ¯idï¼Œç”¨äºæ ‡è¯†æ¶ˆæ¯div
      const messageId = "assistant-" + Date.now();

      while (true) {
        const { done, value } = await reader.read();
        if (done) {
          console.log("Stream complete");
          conversationHistory.push({ role: "assistant", content: aiMessage });
          document.querySelector("#chat-btn").disabled = false;
          return;
        }
        if (isLoading) closeLoading();

        const chunk = decoder.decode(value, { stream: true });
        let messages = (partialMessage + chunk).split("\n");
        partialMessage = messages.pop();

        // è¿‡æ»¤æ•°ç»„é‡Œçš„ç©ºå­—ç¬¦ä¸²
        messages = messages.filter(message => message);

        for (const message of messages) {
          if (!message) continue; // å¿½ç•¥ç©ºå­—ç¬¦ä¸²
          if (message === "data: [DONE]") {
            break;
          }
          const jsonStartIndex = message.indexOf("{");
          const jsonData = message.slice(jsonStartIndex);
          const dataObject = JSON.parse(jsonData);

          const aiResponse = dataObject.choices[0].delta.content;
          if (aiResponse) {
            aiMessage += aiResponse;
            console.log(aiResponse);
            appendToConversationHistory("AI", aiMessage, messageId);
          }

        }
      }
    })
    .catch(error => console.log('error', error));
}

function appendToConversationHistory(role, content, messageElementId) {
  const historyContainer = document.getElementById("conversation-history");

  let messageElement = document.getElementById(messageElementId);
  if (!messageElement) {
    messageElement = document.createElement("div");
    messageElement.id = messageElementId;
    messageElement.classList.add(role + "-message");
    historyContainer.appendChild(messageElement);
  }

  let formattedContent = nextLineMedials(true,content);

  // æ£€æŸ¥å†…å®¹ä¸­æ˜¯å¦åŒ…å«ä»£ç å—æ ‡è®°
  const codeBlockRegex = /```(\w+)?([\s\S]*?)```|`([^`]+)`/g;
  formattedContent = formattedContent.replace(codeBlockRegex, (match, lang, blockContent, inlineContent) => {
    if (blockContent) {
      blockContent = trimString( nextLineMedials(false,blockContent,"\n"), "\n")
      return `<pre> 
                <span class="code-type">${lang || "plaintext"}</span> 
                <code>${escapeHtml(blockContent)}</code>
              </pre>`;
    } else if (inlineContent) {
      inlineContent = nextLineMedials(false,inlineContent,"\n")
      // å¤„ç†è¡Œå†…ä»£ç ï¼Œå°†HTMLæ ‡ç­¾å­—ç¬¦è½¬ä¹‰
      return `<code> ${escapeHtml(inlineContent)} </code>`;
    }
    return match;
  });
  formattedContent = nextLineMedials(false,formattedContent,"<br />")

  messageElement.innerHTML = role + " : " + formattedContent;
}

// \n => ä¸­é—´å­—ç¬¦ => <br /> | \n
function nextLineMedials(isToMedials = true, content = "", target = "") {
  if(isToMedials) {
    return content.replace(/(\n)+/g, "[[$æ¢è¡Œ$]]")
  } else {
    return content.replace(/\[\[\$æ¢è¡Œ\$\]\]/g, target);
  }
}
// å»é™¤ä¸¤è¾¹çš„\n
function trimNewlines(str) {
    return str.replace(/^\n+|\n+$/g, '');
}
// è½¬ä¹‰ HTML æ ‡ç­¾å­—ç¬¦(ä»£ç å—ç‰¹æ®Šå­—ç¬¦ä¹Ÿç›´æ¥æ˜¾ç¤ºï¼Œç›¸å½“innerText)
function escapeHtml(str) {
  return str.replace(/[&<>"'\/]/g, function (match) {
    const escapeMap = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;',
      '/': '&#47;'
    };
    return escapeMap[match];
  });
}

function openLoading() {
  isLoading = true;
  // åˆ›å»ºloading èŠ‚ç‚¹
  const loadingElement = document.createElement("div");
  loadingElement.id = "loading";
  loadingElement.style.display = "inline-block";
  // æŒ‚åœ¨åˆ°historyContainer
  document.getElementById("conversation-history").appendChild(loadingElement);
}

function closeLoading() {
  isLoading = false;
  // åˆ é™¤loadingèŠ‚ç‚¹
  document.getElementById("loading").remove();
}

// ç»™å‘é€æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
sendBtn.addEventListener("click", () => chat());
// ç›‘å¬msg push äº‹ä»¶(æ–°ç‰ˆæœ¬ä½¿ç”¨MS_SCRIPT_ENVæ›¿æ¢åŸæ¥çš„MS_script_env_varï¼Œä¸‹é¢å†™æœ‰å…¼å®¹ä»£ç )
window.MS_SCRIPT_ENV.event.sendListener.push((fillKeyword)=> {
    console.log("å·²æ¥æ”¶åˆ°ï¼š", fillKeyword);
    if (`${fillKeyword}`.trim().length === 0) return;
    inputDocument.value = fillKeyword; // æ‰‹åŠ¨è®¾ç½®å€¼
    chat(); // ç‚¹å‡»send
});
// å›è½¦å‘é€äº‹ä»¶
inputDocument.addEventListener('keypress', function(event) {
  // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº† "Enter" é”®
  if (event.key === 'Enter') {
    // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆé˜²æ­¢åœ¨è¡¨å•ä¸­è§¦å‘æäº¤ç­‰ï¼‰
    event.preventDefault();
    // è§¦å‘æŒ‰é’®ç‚¹å‡»
    chat();
  }
});
